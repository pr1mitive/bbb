# kintone 発注管理システム 運用マニュアル

**バージョン**: 1.0  
**最終更新**: 2026年2月14日  
**対象ユーザー**: 発注担当者、経理担当者、システム管理者

---

## 📋 目次

1. [システム概要](#1-システム概要)
2. [アクセス方法](#2-アクセス方法)
3. [マスタデータ管理](#3-マスタデータ管理)
4. [発注書作成フロー](#4-発注書作成フロー)
5. [案件配分機能](#5-案件配分機能)
6. [見積参照・取込](#6-見積参照取込)
7. [ERP連携](#7-erp連携)
8. [レポート・出力](#8-レポート出力)
9. [トラブルシューティング](#9-トラブルシューティング)
10. [よくある質問](#10-よくある質問)

---

## 1. システム概要

### 1.1 システムの目的

kintone発注管理システムは、見積から発注、ERP連携までの購買業務を一元管理し、以下を実現します:

- 📝 **発注書の効率的な作成**: 見積データからワンクリック取込
- 🏗️ **案件別数量管理**: 1つの発注を複数案件に配分
- 🔄 **ERP連携**: 案件別に展開したデータを自動生成・CSV出力
- 📊 **データの可視性**: リアルタイムでの発注状況把握

### 1.2 システム構成

```
┌─────────────────────────────────────────────────┐
│            kintone 発注管理システム              │
└─────────────────────────────────────────────────┘
         ┌──────────┬──────────┬──────────┐
         │          │          │          │
    ┌────▼───┐ ┌───▼────┐ ┌──▼─────┐ ┌─▼──────┐
    │ 発注管理 │ │マスタ群│ │見積管理│ │基本情報│
    │  アプリ  │ │ Apps  │ │ アプリ │ │ Master │
    └─────┬───┘ └────────┘ └────────┘ └────────┘
          │
    ┌─────▼──────────────────────────┐
    │   カスタムビュー「発注登録画面」  │
    │  - JavaScript 10ファイル構成    │
    │  - カスタムCSS適用              │
    └────────────────────────────────┘
```

#### アプリ一覧

| アプリ名 | App ID | 用途 |
|---------|--------|------|
| **発注管理** | (設定要) | 発注書の作成・管理 |
| 発注先マスタ | 746 | 発注先企業情報 |
| アイテムマスタ | 745 | 商品・部品情報 |
| 見積マスタ | 750 | 見積データ |
| 基本情報マスタ | 749 | 発注元・通貨・税コード |
| 案件マスタ | 674 | 案件番号・名称 |
| 倉庫マスタ | 747 | 倉庫情報（将来拡張用） |

### 1.3 主要機能一覧

#### ✅ 実装済み機能

- [x] **カスタム発注登録画面**: 一覧画面から専用UIで発注書作成
- [x] **マスタ連携**: 発注先・アイテム・見積・案件の検索・選択
- [x] **見積参照**: 見積データから明細を一括取込
- [x] **案件配分**: 各明細行を複数案件に分割
- [x] **Excel形式貼り付け**: 案件番号と数量をタブ区切りで一括入力
- [x] **ERP用テーブル自動生成**: 案件別に展開した明細を自動作成
- [x] **金額計算**: 小計・消費税・合計の自動計算
- [x] **為替対応**: 外貨建て発注の円換算
- [x] **下書き保存**: 作成途中のデータを保存

#### 🔧 今後の拡張予定

- [ ] Excel発注書出力 (Reportonプラグイン)
- [ ] PDF発注書生成
- [ ] 承認ワークフロー連携
- [ ] 在庫管理連携
- [ ] 入荷管理機能

---

## 2. アクセス方法

### 2.1 ログイン

1. ブラウザで kintone にアクセス
2. ユーザーID・パスワードでログイン
3. 「発注管理」アプリを選択

**推奨ブラウザ**: Chrome、Edge、Firefox 最新版

### 2.2 発注登録画面を開く

1. 発注管理アプリの一覧画面を表示
2. 画面右上の **ビュー選択** で「発注登録画面」を選択
3. カスタムUIが表示されます

> ⚠️ **注意**: 標準の一覧・詳細画面では案件配分機能は使用できません。必ず「発注登録画面」ビューを使用してください。

---

## 3. マスタデータ管理

発注書作成の前に、以下のマスタデータが登録されている必要があります。

### 3.1 発注先マスタ

**登録内容**:
- 発注先コード（例: V001）
- 発注先名称
- 住所
- 担当者名
- 電話番号
- メールアドレス
- 支払条件（例: 月末締め翌月末払い）

**登録手順**:
1. 「発注先マスタ」アプリを開く
2. 「+」ボタンで新規レコード作成
3. 必須項目を入力し保存

### 3.2 アイテムマスタ

**登録内容**:
- アイテムコード（例: A001）
- アイテム名称
- カテゴリ
- 在庫管理区分（在庫品 / 非在庫品）
- 標準単価
- 単位（例: 個、kg、m）
- 仕様・詳細

**重要**: 案件配分を行う場合、アイテムコードが必須です。

### 3.3 案件マスタ

**登録内容**:
- 案件番号（例: P001）
- 案件名称
- ステータス

**案件番号ルール**:
- 形式: 英字1文字 + 数字3桁（P001、P002...）
- 案件配分で使用するため、正確に登録

### 3.4 基本情報マスタ

**登録内容**:

| データ種別 | コード例 | 名称例 |
|-----------|---------|-------|
| 発注元 | ORDER_SRC_01 | 東京本社 |
| 通貨 | JPY | 日本円 |
| 通貨 | USD | 米ドル |
| 税コード | TAX_10 | 消費税10% |
| 税コード | TAX_08 | 軽減税率8% |

**税率設定**: 「税率」フィールドに数値で入力（例: 10% → `10`）

---

## 4. 発注書作成フロー

### 4.1 基本情報の入力

#### ステップ1: 発注元選択

1. 「発注元」ドロップダウンから選択（例: 東京本社）
2. 住所・代表者が自動入力されます

#### ステップ2: 発注先選択

1. 「発注先」の **🔍 検索** ボタンをクリック
2. 発注先検索モーダルが開きます
3. キーワード入力 → **検索** ボタン
4. 結果から **選択** ボタンをクリック
5. 発注先名・住所・担当者が自動入力されます

#### ステップ3: 基本項目入力

- **発注日**: カレンダーから選択
- **件名**: 発注の概要を入力（例: 2026年2月部品発注）
- **納期**: 希望納期を入力
- **納入場所**: ドロップダウンから選択
- **通貨**: JPY / USD / EUR から選択
- **為替レート**: 外貨の場合は入力（JPYは自動で1.00）
- **税コード**: 税率を選択

### 4.2 発注明細の入力

#### 方法A: 手動入力

1. 「+ 明細行追加」ボタンをクリック
2. 各項目を入力:
   - **アイテムコード**: 🔍 ボタンで検索
   - **アイテム名**: 自動入力（手動編集可）
   - **詳細項目**: 仕様や追加情報を入力
   - **単価**: 数値入力
   - **数量**: 数値入力
   - **単位**: 自動入力（手動編集可）
   - **金額**: 自動計算（単価 × 数量）
   - **案件**: 後で配分する場合は空欄でOK
   - **備考**: 補足情報

3. 必要に応じて「+ 明細行追加」で行を追加（最大20行）

#### 方法B: 見積から一括取込

詳細は [6. 見積参照・取込](#6-見積参照取込) を参照。

### 4.3 金額の確認

画面下部の金額サマリーで確認:

```
┌─────────────────────────┐
│ 小計: ¥100,000          │
│ 消費税: ¥10,000         │
│ 合計: ¥110,000          │
│ (円換算: ¥110,000)      │
└─────────────────────────┘
```

- **小計**: 全明細行の金額合計
- **消費税**: 小計 × 税率
- **合計**: 小計 + 消費税
- **円換算**: 外貨の場合のみ表示

### 4.4 保存・登録

#### 下書き保存

- **💾 下書き保存** ボタン: ステータス「下書き」で保存
- 後で編集可能
- 承認・ERP連携は行われません

#### 本登録

- **✅ 登録** ボタン: ステータス「承認待ち」で保存
- 確認ダイアログで内容を確認
- 登録後は詳細画面にリダイレクト

---

## 5. 案件配分機能

### 5.1 案件配分とは

1つの発注明細を複数の案件に分割する機能です。

**使用例**:
- アイテムA を 10個 発注
- 案件P001 に 6個 割当
- 案件P002 に 4個 割当

→ ERP連携時に2行に展開されます

### 5.2 案件配分の手順

#### ステップ1: 案件配分ボタンをクリック

1. 発注明細テーブルの「案件」列にある **+ 案件配分** ボタンをクリック
2. 案件配分モーダルが開きます

#### ステップ2: 案件と数量を入力

**モーダル画面の構成**:

```
┌─────────────────────────────────────┐
│ 案件配分 (アイテム: A001)      [×]  │
├─────────────────────────────────────┤
│ 明細数量: 10                        │
│ 配分済数量: 6 / 10 ⚠️               │
├─────────────────────────────────────┤
│ 案件番号 | 配分数量 | 操作           │
│─────────┼─────────┼──────         │
│ P001    │    6    │ [削除]         │
│ P002    │    4    │ [削除]         │
├─────────────────────────────────────┤
│ [+ 案件を追加] [📋 貼り付け]        │
│                   [キャンセル] [OK] │
└─────────────────────────────────────┘
```

#### 方法A: 手動入力

1. **+ 案件を追加** ボタンをクリック
2. 新しい行が追加されます
3. 「案件番号」を入力（例: P001）
4. 「配分数量」を入力（例: 6）
5. 必要に応じて繰り返し

#### 方法B: Excel形式で貼り付け

1. **📋 貼り付け** ボタンをクリック
2. Excel や Google Sheets で以下の形式でコピー:

```
P001	6
P002	4
```

または見出し付き:

```
案件番号	配分数量
P001	6
P002	4
```

3. 貼り付けダイアログに **Ctrl+V** (Windows) / **Cmd+V** (Mac)
4. **OK** ボタンで確定

> 💡 **ヒント**: タブ区切り（TSV形式）でコピーしてください。カンマ区切り（CSV）は使用できません。

#### ステップ3: 配分内容の確認

- **配分済数量**: 入力した数量の合計が表示されます
- **アイコン**: 
  - ✅ 緑チェック: 明細数量と一致（正常）
  - ⚠️ 黄色警告: 数量が一致しない

**バリデーション**:
- ✅ 配分合計 = 明細数量 → OK
- ❌ 配分合計 ≠ 明細数量 → 警告表示（登録は可能だが推奨しない）
- ❌ 同じ案件番号が重複 → エラー表示、重複を解消するまでOK不可

#### ステップ4: 確定

- **OK** ボタン: 配分内容を保存してモーダルを閉じる
- **キャンセル** ボタン: 変更を破棄してモーダルを閉じる

### 5.3 案件配分の表示

配分後、明細テーブルの「案件」列にタグ表示:

```
┌─────────────────────────┐
│ [P001] [P002] [+ 案件配分] │
└─────────────────────────┘
```

- 青色のタグ: 配分済みの案件
- タグをクリック: 再編集（モーダルが開きます）

### 5.4 案件配分なしの場合

案件配分を行わずに登録した場合:
- ERPテーブルには案件番号が空白の1行が生成されます
- 後から詳細画面で編集することはできません
- 必要な場合は発注書を作り直してください

---

## 6. 見積参照・取込

### 6.1 見積参照の前提条件

- **見積マスタ**に見積データが登録済みであること
- 見積の「発注先コード」と発注書の「発注先」が一致すること

### 6.2 見積取込の手順

#### ステップ1: 発注先を選択

見積参照機能は発注先コードで絞り込むため、先に発注先を選択してください。

#### ステップ2: 見積参照ボタンをクリック

1. 「基本情報」セクションの **📋 見積参照** ボタンをクリック
2. 見積参照モーダルが開きます

#### ステップ3: 見積を検索

**初期表示**: 選択した発注先の全見積が表示されます

**検索**:
1. 検索ボックスにキーワード入力（見積番号・件名）
2. **🔍 検索** ボタンをクリック
3. 該当する見積のみが表示されます

#### ステップ4: 見積を選択

見積カード:

```
┌─────────────────────────────────┐
│ 見積番号: Q-2026-001             │
│ 見積件名: 2月部品見積            │
│ 通貨: JPY                       │
│ 有効期限: 2026-03-31            │
│ 明細行数: 5                      │
│                [この見積を取込]   │
└─────────────────────────────────┘
```

**[この見積を取込]** ボタンをクリック

#### ステップ5: 取込確認

既に明細行がある場合、確認ダイアログが表示:

```
既存の明細を上書きしますか？
- OK: 既存の明細を削除して見積を取込
- キャンセル: 取込中止
```

#### ステップ6: 取込結果確認

- 見積の明細が発注明細テーブルに追加されます
- 通貨が見積の通貨に自動変更されます
- 成功メッセージ: 「見積から 5 件の明細を取り込みました」

### 6.3 取込後の調整

取込後、以下の調整が可能です:

- ✏️ 数量・単価の変更
- 📝 詳細項目・備考の追加
- ➕ 明細行の追加
- ❌ 不要な行の削除
- 🏗️ 案件配分の設定

---

## 7. ERP連携

### 7.1 ERP連携の仕組み

**データフロー**:

```
発注明細テーブル (po_items)
  アイテムA, 数量10, 案件[P001:6, P002:4]
         ↓
    レコード保存時
         ↓
ERP登録用テーブル (erp_items) に自動展開
  行1: A001, ステンレス製, P001, 6, 1000
  行2: A001, ステンレス製, P002, 4, 1000
```

**ポイント**:
- 案件配分を行った明細は、案件ごとに1行ずつ生成
- 案件配分なしの明細は、案件番号が空白で1行生成
- 発注明細に変更があっても、ERPテーブルは自動更新されません（再保存が必要）

### 7.2 ERPテーブルのフィールド構成

| フィールド名 | 説明 | 例 |
|------------|------|-----|
| erp_item_code | アイテムコード | A001 |
| erp_item_detail | 詳細項目 | ステンレス製・特注仕様 |
| erp_project_id | 案件番号 | P001 |
| erp_quantity | 配分数量 | 6 |
| erp_unit_price | 単価 | 1000 |

### 7.3 CSV出力（今後実装予定）

**出力手順** (実装後):
1. 発注管理アプリの詳細画面を開く
2. 「ERP登録用明細」テーブルのメニューから **CSV出力**
3. ファイルをダウンロード
4. ERPシステムに取込

**ファイル形式**:
```csv
アイテムコード,詳細項目,案件番号,数量,単価
A001,ステンレス製,P001,6,1000
A001,ステンレス製,P002,4,1000
```

---

## 8. レポート・出力

### 8.1 標準レポート機能

kintone の標準機能で以下のレポートが作成可能:

#### 発注状況一覧

**設定**:
- グラフ種類: テーブル
- 表示フィールド: 発注番号、発注先、件名、発注日、合計、ステータス
- フィルタ: ステータス = 「承認待ち」「発注済み」

#### 発注先別集計

**設定**:
- グラフ種類: 集計表
- 横軸: 発注先
- 縦軸: 合計 (合計)
- フィルタ: 発注日が今月

#### 案件別集計

**設定**:
- グラフ種類: 集計表
- 横軸: 案件番号 (ERPテーブル経由)
- 縦軸: 数量 (合計)

### 8.2 Excel出力（今後実装予定）

**Reporton プラグイン**を使用した発注書PDF/Excel出力:

1. 詳細画面で「発注書出力」ボタンをクリック
2. テンプレート選択
3. ファイルをダウンロード

**出力フォーマット**:
- 会社ロゴ付き
- 発注番号・発注日
- 発注元・発注先情報
- 明細テーブル
- 合計・消費税・総計

---

## 9. トラブルシューティング

### 9.1 カスタムビューが表示されない

**症状**: 「発注登録画面」を選択しても標準の一覧が表示される

**原因**:
- カスタムビューが正しく設定されていない
- JavaScriptがアップロードされていない

**対処法**:
1. アプリ設定 → 「一覧」を確認
2. 「発注登録画面」ビューの種類が「カスタマイズ」であることを確認
3. 「JavaScript / CSSでカスタマイズ」に全ファイルがアップロードされているか確認
4. ブラウザのキャッシュをクリア (Ctrl+Shift+R)

### 9.2 UIが崩れている

**症状**: ボタン・入力欄の配置がおかしい、モーダルが最初から表示される

**原因**:
- CSSファイルが読み込まれていない
- JavaScriptの読み込み順序が間違っている

**対処法**:
1. `styles_updated.js` がアップロードされているか確認
2. JavaScriptファイルの順序を確認:
   ```
   1. config.js
   2. utils.js
   3. masterData.js
   4. calculator.js
   5. styles_updated.js
   6. customView_part1.js
   7. customView_part2_updated.js
   8. customView_part3_updated.js
   9. projectAllocation.js
   10. erpBuilder.js
   ```
3. ブラウザコンソール (F12) でエラーを確認
4. キャッシュクリア後に再度アクセス

### 9.3 マスタデータが選択できない

**症状**: 発注先・アイテムの検索ボタンを押しても何も表示されない

**原因**:
- マスタアプリにデータが登録されていない
- App IDが間違っている
- アクセス権限がない

**対処法**:
1. 該当マスタアプリを開いてデータがあるか確認
2. `config.js` の `APP_IDS` 設定を確認
3. マスタアプリの閲覧権限があるか確認

### 9.4 案件配分ボタンが表示されない

**症状**: 明細行に「+ 案件配分」ボタンが出ない

**原因**:
- `projectAllocation.js` がアップロードされていない
- JavaScriptエラーが発生している

**対処法**:
1. コンソール (F12) でエラーを確認
2. `projectAllocation.js` がアップロードされているか確認
3. `customView_part2_updated.js` に案件配分ボタンのHTMLが含まれているか確認

### 9.5 配分数量の合計が一致しない

**症状**: 案件配分で合計が明細数量と異なる警告が出る

**原因**:
- 入力ミス
- 案件が重複している

**対処法**:
1. 各案件の配分数量を再確認
2. 同じ案件番号が複数ないか確認
3. 配分合計 = 明細数量 になるよう調整
4. 数量の小数点以下の扱いに注意

### 9.6 ERPテーブルが生成されない

**症状**: レコード保存後、ERPテーブルが空

**原因**:
- `erpBuilder.js` がアップロードされていない
- `customView_part3_updated.js` でERP生成処理が呼ばれていない
- ERPテーブルのフィールドが設定されていない

**対処法**:
1. アプリ設定 → フォーム → 「ERP登録用明細」テーブルがあるか確認
2. 必須フィールド (erp_item_code, erp_item_detail, erp_project_id, erp_quantity, erp_unit_price) が全て存在するか確認
3. コンソールで `ERPBuilder.generateERPItems` 関数が実行されているか確認

### 9.7 見積参照で見積が表示されない

**症状**: 見積参照モーダルが開くが「該当する見積がありません」

**原因**:
- 見積マスタにデータがない
- 発注先コードが一致していない
- 見積の有効期限が切れている

**対処法**:
1. 見積マスタアプリを開いてデータを確認
2. 見積の「発注先コード」と発注書の「発注先」が一致しているか確認
3. 見積の有効期限を確認（期限切れでもフィルタされる場合がある）

### 9.8 JavaScriptエラーの確認方法

1. ブラウザで **F12** キーを押す
2. 「Console」タブを開く
3. エラーメッセージ (赤色) を確認
4. エラーが発生したファイル名と行番号をメモ
5. システム管理者に報告

**よくあるエラーメッセージ**:

| エラー | 原因 | 対処 |
|-------|------|------|
| `CONFIG is not defined` | config.js未読み込み | アップロード確認 |
| `openQuoteModal is not defined` | customView_part2 問題 | ファイル差し替え |
| `addCustomCSS is not defined` | styles_updated.js 問題 | 最新版に更新 |
| `Cannot read property 'value' of null` | フィールドID不一致 | config.js 確認 |

---

## 10. よくある質問

### Q1. 発注書の修正はできますか?

**A**: ステータスによって異なります。

- **下書き**: 詳細画面で編集可能
- **承認待ち以降**: 編集不可 (承認ワークフロー連携時)
- **カスタムビューでの再編集**: 不可 (新規作成のみ)

修正が必要な場合は、発注書を複製して新規作成してください。

### Q2. 案件配分は後から追加できますか?

**A**: カスタムビューから新規作成時のみ可能です。

登録後に案件配分を追加・変更することはできません。案件配分が必要な場合は、最初の登録時に必ず設定してください。

### Q3. 複数の通貨を混在できますか?

**A**: 1つの発注書では1つの通貨のみ使用できます。

異なる通貨で発注する場合は、別々の発注書を作成してください。

### Q4. 明細行は何行まで追加できますか?

**A**: 最大 **20行** です。

これは `config.js` の `MAX_ITEMS` で設定されています。より多くの明細が必要な場合は、発注書を分割するか、システム管理者に設定変更を依頼してください。

### Q5. 見積を取り込むと既存の明細は消えますか?

**A**: 確認ダイアログで選択できます。

- **OK**: 既存明細を削除して見積を取込
- **キャンセル**: 取込を中止

既存明細を残したい場合は、見積取込前にメモを取るか、別の発注書として作成してください。

### Q6. ERPテーブルは手動で編集できますか?

**A**: 推奨しません。

ERPテーブルは発注明細から自動生成されるため、手動編集すると次回保存時に上書きされます。明細を修正したい場合は、発注明細を編集して再保存してください。

### Q7. CSV出力の文字化けを防ぐには?

**A**: 以下の方法を試してください。

1. Excelで開く場合:
   - 「データ」タブ → 「テキストファイル」から開く
   - 文字コード「UTF-8」を選択
2. Google Spreadsheetsで開く:
   - ファイル → インポート → アップロード
   - 自動的に文字コード判定されます

### Q8. アイテムコードは必須ですか?

**A**: 任意ですが、ERP連携を行う場合は推奨です。

アイテムコードがないと、ERP側でデータを正しく処理できない可能性があります。

### Q9. 案件番号の形式は自由ですか?

**A**: 案件マスタに登録されている番号のみ使用できます。

案件配分モーダルでは、案件マスタに存在しない番号も入力できますが、レポート作成時に問題が発生する可能性があるため、マスタに登録された番号を使用してください。

### Q10. 発注書番号は自動採番ですか?

**A**: はい、`PO-YYYYMMDD-001` 形式で自動生成されます。

- `YYYY`: 年
- `MM`: 月
- `DD`: 日
- `001`: 当日の連番

例: `PO-20260214-001`、`PO-20260214-002`...

---

## 📞 サポート連絡先

### システム管理者

- **担当者**: [担当者名]
- **メール**: [メールアドレス]
- **内線**: [内線番号]

### 対応時間

- 平日 9:00 - 18:00
- 緊急時は24時間対応

### 問い合わせ時の情報

以下の情報を準備してください:

1. ユーザー名・所属
2. 発生日時
3. 操作内容
4. エラーメッセージ (スクリーンショット)
5. ブラウザの種類・バージョン

---

## 📝 改訂履歴

| バージョン | 日付 | 変更内容 | 担当者 |
|-----------|------|---------|-------|
| 1.0 | 2026-02-14 | 初版作成 | - |

---

**© 2026 kintone 発注管理システム. All Rights Reserved.**
