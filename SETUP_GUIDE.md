# 発注管理システム - 案件配分・ERP連携機能 導入ガイド

## 📦 パッケージ内容

このパッケージには、案件配分機能とERP連携テーブル自動生成機能が含まれています。

### 更新ファイル一覧

1. **config.js** – ERP登録用テーブルフィールドを追加
2. **projectAllocation.js** – 案件配分モーダル機能(新規)
3. **erpBuilder.js** – ERP登録用テーブル生成ロジック(新規)
4. **customView_part2_updated.js** – 案件配分ボタンを追加した明細行処理
5. **customView_part3_updated.js** – ERP登録用テーブル自動生成を追加したレコード登録処理
6. **styles_updated.js** – 案件配分モーダル用CSS追加

### その他のファイル(変更なし、既存のものを使用)

- utils.js
- masterData.js
- calculator.js
- customView_part1.js

---

## 🚀 導入手順

### ステップ1: 既存JavaScriptのバックアップ

念のため、現在の発注管理アプリに設定されているJavaScriptファイルをバックアップしてください。

1. 発注管理アプリの設定画面を開く
2. 「設定」→「JavaScript / CSSでカスタマイズ」を開く
3. 現在のファイル一覧をスクリーンショットまたはメモ

### ステップ2: カスタムビューIDの確認・設定

1. 発注管理アプリで「発注登録画面」カスタムビューを開く
2. URLから `view=` の後の数字を確認(例: `view=5511111` → `5511111`)
3. **config.js** の以下の行を編集:
   ```javascript
   CUSTOM_VIEW_ID: 'XXXXX',  // ← ここに実際のビューIDを入力
   ```
   例:
   ```javascript
   CUSTOM_VIEW_ID: '5511111',
   ```

### ステップ3: JavaScriptファイルのアップロード

発注管理アプリの設定画面で、以下の順序でJavaScriptファイルをアップロードしてください。

#### 📋 アップロード順序(重要!)

1. **config.js** (最新版)
2. **utils.js** (既存)
3. **masterData.js** (既存)
4. **calculator.js** (既存)
5. **styles_updated.js** (最新版) ※ 既存の `styles.js` を削除してこれに置き換え
6. **customView_part1.js** (既存)
7. **customView_part2_updated.js** (最新版) ※ 既存の `customView_part2.js` を削除してこれに置き換え
8. **customView_part3_updated.js** (最新版) ※ 既存の `customView_part3.js` を削除してこれに置き換え
9. **projectAllocation.js** (新規)
10. **erpBuilder.js** (新規)

#### 🔧 アップロード方法

1. 「JavaScript / CSSでカスタマイズ」画面で、既存のJavaScriptファイルを削除
   - `styles.js` を削除
   - `customView_part2.js` を削除
   - `customView_part3.js` を削除
   - `config.js` を削除

2. 上記順序で新しいファイルをアップロード
   - 「URLを指定する」ではなく、「アップロードする」を選択
   - ファイルを選択してアップロード

3. 「アプリを更新」ボタンをクリック

### ステップ4: 動作確認

1. **カスタムビューを開く**
   - 発注管理アプリで「発注登録画面」を開く
   - 画面が正常に表示されることを確認

2. **マスタデータの読み込み確認**
   - ブラウザのコンソール(F12キー)を開く
   - 「発注元」「発注先」「通貨」「税コード」のドロップダウンにデータが表示されることを確認

3. **明細行の追加**
   - 「+ 明細行追加」ボタンをクリック
   - 明細行が正常に追加されることを確認

4. **案件配分ボタンの確認**
   - 明細行に「案件配分」ボタンが表示されていることを確認
   - ボタンをクリックしてモーダルが開くことを確認

5. **案件配分モーダルの動作確認**
   - アイテムコードと数量を入力した状態で「案件配分」ボタンをクリック
   - モーダルが開くことを確認
   - 案件番号と配分数量を入力
   - 「+ 案件を追加」ボタンで行が追加されることを確認
   - 「🗑」ボタンで行が削除されることを確認
   - 「OK」ボタンで保存し、ボタンが「案件配分 (2件)」のように変わることを確認

6. **貼り付け機能の確認**
   - 以下のテキストをコピー:
     ```
     P001	6
     P002	4
     ```
   - 案件配分モーダルを開く
   - 「📋 貼り付け」ボタンをクリック
   - データが正しく貼り付けられることを確認

7. **レコード登録の確認**
   - すべての必須項目を入力
   - 明細行を追加し、案件配分も設定
   - 「登録」ボタンをクリック
   - レコードが正常に登録されることを確認
   - 登録後、詳細画面に遷移することを確認

8. **ERP登録用テーブルの確認**
   - 詳細画面で「ERP登録用明細」テーブルを確認
   - 案件配分に応じて正しく展開されていることを確認
   - 例:
     - 明細行1: アイテムA、数量10、案件P001(6個)、P002(4個)
     - → ERP登録用テーブル:
       - 行1: アイテムA、案件P001、数量6
       - 行2: アイテムA、案件P002、数量4

---

## ✅ 動作確認チェックリスト

- [ ] カスタムビューが正常に表示される
- [ ] マスタデータ(発注元、発注先、通貨、税コード)が読み込まれる
- [ ] 明細行の追加・削除ができる
- [ ] アイテム検索モーダルが動作する
- [ ] 見積参照・一括取込が動作する
- [ ] 案件配分ボタンが各明細行に表示される
- [ ] 案件配分モーダルが開く
- [ ] 案件配分モーダルで行の追加・削除ができる
- [ ] 貼り付け機能が動作する
- [ ] 配分数量の合計チェックが動作する
- [ ] 案件配分保存後、ボタンが「案件配分 (X件)」と表示される
- [ ] レコード登録が成功する
- [ ] ERP登録用テーブルが正しく生成される
- [ ] 案件配分なしの明細行も正しくERP登録用テーブルに保存される

---

## 🐛 トラブルシューティング

### Q1. カスタムビューを開いても何も表示されない

**原因:**
- カスタムビューIDが正しく設定されていない
- JavaScriptファイルの読み込み順序が間違っている
- JavaScriptにエラーがある

**解決方法:**
1. ブラウザのコンソール(F12キー)を開き、エラーメッセージを確認
2. `config.js` の `CUSTOM_VIEW_ID` が正しいか確認
3. JavaScriptファイルのアップロード順序を確認
4. ブラウザのキャッシュをクリア(Ctrl + Shift + R)

### Q2. マスタデータ(発注元、発注先など)が表示されない

**原因:**
- マスタアプリにデータが登録されていない
- アプリIDが間違っている
- マスタアプリのアクセス権限がない

**解決方法:**
1. マスタアプリ(746, 745, 750, 749)にデータが登録されているか確認
2. `config.js` のアプリIDが正しいか確認
3. マスタアプリへの閲覧権限があるか確認

### Q3. 案件配分ボタンをクリックしても何も起こらない

**原因:**
- アイテムコードまたは数量が入力されていない
- JavaScriptのエラー

**解決方法:**
1. アイテムコードと数量を入力してから案件配分ボタンをクリック
2. ブラウザのコンソールでエラーメッセージを確認

### Q4. 案件配分モーダルで貼り付けができない

**原因:**
- ブラウザのクリップボード権限がない
- データフォーマットが間違っている

**解決方法:**
1. ブラウザの設定でクリップボードへのアクセスを許可
2. 貼り付けデータのフォーマットを確認:
   ```
   P001	6
   P002	4
   ```
   (タブ区切り、改行区切り)

### Q5. レコード登録時にエラーが発生する

**原因:**
- 必須項目が入力されていない
- フィールドコードが間違っている
- ERP登録用テーブルのフィールドが存在しない

**解決方法:**
1. すべての必須項目(発注元、発注先、発注日、件名、通貨、税コード)を入力
2. 明細行の必須項目(アイテム名、単価、数量)を入力
3. `config.js` のフィールドコードが実際のフィールドコードと一致しているか確認
4. ERP登録用テーブル(`erp_items`)とその5つのフィールドが存在するか確認

### Q6. ERP登録用テーブルが生成されない

**原因:**
- ERP登録用テーブル(`erp_items`)が存在しない
- フィールドコードが間違っている

**解決方法:**
1. 発注管理アプリに `erp_items` テーブルが追加されているか確認
2. テーブル内に以下のフィールドがあるか確認:
   - `erp_item_code`
   - `erp_item_detail`
   - `erp_project_id`
   - `erp_quantity`
   - `erp_unit_price`
3. フィールドコードが設計書通りか確認

---

## 🎯 使用方法

### 基本的な発注登録フロー

1. **発注元・発注先の選択**
   - ドロップダウンから選択

2. **発注日・件名の入力**
   - 発注日はデフォルトで今日の日付が入力されます

3. **通貨・税コードの選択**
   - ドロップダウンから選択
   - 税率は自動で設定されます

4. **明細行の追加**
   - 「+ 明細行追加」ボタンをクリック
   - アイテムコード、アイテム名、単価、数量を入力
   - または「🔍」ボタンでアイテム検索モーダルから選択

5. **案件配分の設定(オプション)**
   - 「案件配分」ボタンをクリック
   - 案件番号と配分数量を入力
   - または「📋 貼り付け」ボタンでエクセルからコピーしたデータを一括入力
   - 「OK」ボタンで保存

6. **レコード登録**
   - 「登録」ボタンをクリック
   - 確認ダイアログで「OK」をクリック
   - レコードが登録され、ERP登録用テーブルも自動生成されます

### 案件配分の貼り付け機能

エクセルやテキストエディタから案件配分データを一括で貼り付けることができます。

**対応フォーマット:**

フォーマット1: 案件番号 + 配分数量(タブ区切り)
```
P001	6
P002	4
P003	5
```

フォーマット2: 列ヘッダー付き(エクセルから直接コピー)
```
案件番号	配分数量
P001	6
P002	4
P003	5
```

**貼り付け手順:**
1. エクセルまたはテキストエディタでデータを選択してコピー(Ctrl + C)
2. 案件配分モーダルを開く
3. 「📋 貼り付け」ボタンをクリック
4. データが自動的にテーブルに貼り付けられます
5. 配分数量の合計を確認
6. 「OK」ボタンで保存

---

## 📊 データ構造

### 発注明細テーブル(po_items)

| フィールド名 | フィールドコード | 保存内容 |
|---|---|---|
| 行番号 | line_no | 1, 2, 3, ... |
| アイテムコード | item_code | A001, B001, ... |
| アイテム名 | item_name | 部品A, 部品B, ... |
| 詳細項目 | item_detail | ステンレス製, ... |
| 単価 | unit_price | 1000, 2000, ... |
| 数量 | quantity | 10, 5, ... |
| 単位 | unit | 個, kg, ... |
| 金額 | amount | 10000, 10000, ... |
| 在庫管理区分 | is_inventory | 在庫品/非在庫品 |
| 備考 | remarks | (自由入力) |

### ERP登録用テーブル(erp_items)

| フィールド名 | フィールドコード | 保存内容 |
|---|---|---|
| アイテムコード | erp_item_code | A001, A001, B001, ... |
| 詳細項目 | erp_item_detail | ステンレス製, ... |
| 案件番号 | erp_project_id | P001, P002, P001, ... |
| 数量 | erp_quantity | 6, 4, 5, ... |
| 単価 | erp_unit_price | 1000, 1000, 2000, ... |

**展開例:**

**発注明細(po_items):**
- 行1: アイテムA、数量10 → 案件配分: P001(6個)、P002(4個)
- 行2: アイテムB、数量5 → 案件配分: P001(5個)

**ERP登録用テーブル(erp_items):**
- 行1: アイテムA、案件P001、数量6、単価1000
- 行2: アイテムA、案件P002、数量4、単価1000
- 行3: アイテムB、案件P001、数量5、単価2000

---

## 🔧 カスタマイズ

### デバッグモードの切り替え

開発中はデバッグモードを有効にし、本番環境では無効にしてください。

**config.js:**
```javascript
DEBUG: true  // 開発中
DEBUG: false // 本番環境
```

デバッグモードが有効の場合、ブラウザのコンソールに詳細なログが出力されます。

### UIカラーのカスタマイズ

**config.js:**
```javascript
UI: {
  COLORS: {
    PRIMARY: '#3498db',     // メインカラー(青)
    SECONDARY: '#95a5a6',   // サブカラー(グレー)
    SUCCESS: '#27ae60',     // 成功(緑)
    DANGER: '#e74c3c',      // 警告(赤)
    WARNING: '#f39c12',     // 注意(オレンジ)
    // ... 他のカラー設定
  }
}
```

### ボタンテキストのカスタマイズ

**config.js:**
```javascript
UI: {
  BUTTON_TEXT: {
    PROJECT_ALLOCATION: '案件配分',
    PASTE: '📋 貼り付け',
    // ... 他のボタンテキスト
  }
}
```

---

## 📞 サポート

導入時に問題が発生した場合は、以下の情報を添えてお問い合わせください:

1. エラーメッセージ(ブラウザのコンソールに表示される内容)
2. 実行した操作内容
3. 発注管理アプリのアプリID
4. カスタムビューID

---

## 📝 更新履歴

### 2026-02-14: 案件配分・ERP連携機能追加
- 案件配分モーダル機能を追加
- エクセルライクな貼り付け機能を追加
- ERP登録用テーブル自動生成機能を追加
- ERP登録用テーブルは5フィールドのシンプル構成に変更
- 発注明細テーブルには案件配分データを保存しない設計に変更

---

以上で導入ガイドは終了です。  
正常に動作することを確認したら、本番運用を開始してください! 🎉
